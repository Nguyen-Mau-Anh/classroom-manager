# Development Dockerfile for Backend with file watching
FROM node:20-alpine

# Enable corepack for pnpm
RUN corepack enable && corepack prepare pnpm@8 --activate

# Install tsx for running TypeScript directly with watch mode
RUN npm install -g tsx

WORKDIR /app

# Copy workspace files
COPY pnpm-workspace.yaml package.json pnpm-lock.yaml tsconfig.json ./
COPY packages/shared/package.json ./packages/shared/
COPY packages/backend/package.json ./packages/backend/

# Install dependencies
RUN pnpm install --frozen-lockfile

# Copy source code
COPY packages/shared ./packages/shared
COPY packages/backend ./packages/backend

# Generate Prisma client
RUN pnpm --filter backend prisma generate || echo "Prisma generate skipped"

# Build shared package
RUN pnpm --filter shared build

# Expose port
EXPOSE 4000

# Start backend with tsx watch mode for hot reload
CMD ["tsx", "watch", "packages/backend/src/server.ts"]
